<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Smart Panel</title>
  <link rel="stylesheet" href="../styles/variables.css">
  <link rel="stylesheet" href="../styles/dashboard.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dark-dashboard-bg">
  <aside class="sidebar-glass">
    <div class="sidebar-header">
      <div class="user-avatar"></div>
      <div>
        <div class="user-name">Jane Doe</div>
        <div class="user-role">Admin</div>
      </div>
    </div>
    <ul>
      <li><a href="dashboard.html" class="active">Dashboard</a></li>
      <li><a href="usuarios.html">Usuarios</a></li>
      <li><a href="dispositivos.html">Dispositivos</a></li>
      <li><a href="reportes.html">Reportes</a></li>
      <li><a href="historico.html">Hist√≥rico</a></li>
      <li><a href="configuracion.html">Configuraci√≥n</a></li>
      <li><a href="../index.html" style="color:#f87171">Cerrar sesi√≥n</a></li>
    </ul>
  </aside>
  <header class="topbar-glass">
    <div class="brand">admin<span style="color:#facc15">kit</span></div>
    <div class="topbar-right">
      <span>settings ‚öôÔ∏è</span>
      <span class="topbar-avatar"></span>
    </div>
  </header>
  <main class="main-content-glass">
    <section class="dashboard-section">
      <h1>Bienvenido a tu Dashboard</h1>
      <div class="dashboard-cards-row">
        <div class="dashboard-card info">
          <div class="card-icon" style="background:#2563eb22;color:#2563eb;">‚ö°</div>
          <div>
            <div class="card-title" id="card-consumo">0 kWh</div>
            <div class="card-desc">Consumo mensual</div>
          </div>
        </div>
        <div class="dashboard-card warning">
          <div class="card-icon" style="background:#f8717122;color:#f87171;">üö®</div>
          <div>
            <div class="card-title" id="card-alertas">0</div>
            <div class="card-desc">Alertas</div>
          </div>
        </div>
        <div class="dashboard-card success">
          <div class="card-icon" style="background:#22c55e22;color:#22c55e;">üîå</div>
          <div>
            <div class="card-title" id="card-activos">0</div>
            <div class="card-desc">Dispositivos activos</div>
          </div>
        </div>
      </div>
      <div class="dashboard-charts-row">
        <div class="dashboard-chart-card">
          <div class="chart-title">Consumo mensual (kWh)</div>
          <canvas id="barChart" width="340" height="150"></canvas>
          <div class="chart-footer">Smart Plug<br><span>Consumo por mes</span></div>
        </div>
        <div class="dashboard-chart-card">
          <div class="chart-title">Consumo diario esta semana</div>
          <canvas id="lineChart" width="340" height="150"></canvas>
          <div class="chart-footer">Smart Plug<br><span>Consumo diario</span></div>
        </div>
      </div>
      <div class="dashboard-table">
        <h2>Hist√≥rico de Consumo</h2>
        <input
          type="text"
          id="table-search"
          placeholder="Buscar por usuario, dispositivo, fecha..."
          style="margin-bottom: 1.2rem; padding: 0.5rem 1rem; border-radius: 8px; border: none; width: 100%; max-width: 350px; background: var(--color-secondary); color: var(--color-text); font-size: 1rem;"
        >
        <table id="main-table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Dispositivo</th>
              <th>Usuario</th>
              <th>Consumo (kWh)</th>
              <th>Costo estimado</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            <!-- El JS llenar√° aqu√≠ las filas -->
          </tbody>
        </table>
        <div id="table-pagination" style="margin-top: 1.2rem; display: flex; gap: 0.5rem; align-items: center;"></div>
      </div>
    </section>
  </main>
  <script src="../js/dashboard.js"></script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // Configuraci√≥n Firebase
  const firebaseConfig = {
    databaseURL: "https://movil-40fec-default-rtdb.firebaseio.com/"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const medicionesRef = ref(db, 'mediciones');

  // Escuchar cambios en tiempo real
  onValue(medicionesRef, (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    // Convertir a array y ordenar por timestamp descendente
    const mediciones = Object.values(data).sort((a, b) => b.timestamp - a.timestamp);

    // Tomar la m√°s reciente
    const ultima = mediciones[0];

    // Simular datos faltantes
    const usuario = "usuario_demo"; // o as√≥cialo con ID si tienes otro nodo
    const costoEstimado = (Math.abs(ultima.active_power) * 0.0015).toFixed(2); // ejemplo de costo
    const estado = ultima.current < 0 ? "Inverso ‚ö†Ô∏è" : "Normal ‚úÖ";

    // Insertar en la tabla
    const tabla = document.querySelector("#main-table tbody");
    tabla.innerHTML = `
      <tr>
        <td>${ultima.datetime}</td>
        <td>${ultima.device_id}</td>
        <td>${usuario}</td>
        <td>${Math.abs(ultima.active_power).toFixed(2)}</td>
        <td>$${costoEstimado}</td>
        <td>${estado}</td>
      </tr>
    `;
  });
</script>
</body>
</html>
